<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">ol{margin:0;padding:0}table td,table th{padding:0}.c0{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c1{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c3{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c2{height:11pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c3 doc-content"><p class="c1"><span class="c0">&lt;!doctype html&gt;</span></p><p class="c1"><span class="c0">&lt;html lang=&quot;en&quot;&gt;</span></p><p class="c1"><span class="c0">&lt;head&gt;</span></p><p class="c1"><span class="c0">&lt;meta charset=&quot;utf-8&quot;&gt;</span></p><p class="c1"><span class="c0">&lt;title&gt;OBER &mdash; Angry Taxi&lt;/title&gt;</span></p><p class="c1"><span class="c0">&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no&quot;&gt;</span></p><p class="c1"><span class="c0">&lt;style&gt;</span></p><p class="c1"><span class="c0">&nbsp; :root{--ui:#fff;--good:#27e59a;--bad:#ff6464;--shadow:rgba(0,0,0,.25)}</span></p><p class="c1"><span class="c0">&nbsp; html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}</span></p><p class="c1"><span class="c0">&nbsp; #game{display:block;width:100vw;height:100vh;touch-action:none}</span></p><p class="c1"><span class="c0">&nbsp; #hud{position:fixed;left:12px;top:10px;z-index:5;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);padding:8px 10px;border-radius:10px;font-weight:600;font-size:14px;line-height:1.2;box-shadow:0 4px 16px var(--shadow);user-select:none}</span></p><p class="c1"><span class="c0">&nbsp; #hud .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}</span></p><p class="c1"><span class="c0">&nbsp; #hud .pill{padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.08);font-weight:700}</span></p><p class="c1"><span class="c0">&nbsp; #envTag{padding:2px 8px;border-radius:6px;background:rgba(255,255,255,.12);font-weight:700}</span></p><p class="c1"><span class="c0">&nbsp; #buttons{position:fixed;right:12px;top:10px;display:flex;gap:8px;z-index:6}</span></p><p class="c1"><span class="c0">&nbsp; .btn{appearance:none;border:none;cursor:pointer;background:rgba(255,255,255,.12);color:#fff;padding:8px 12px;border-radius:10px;font-weight:700;box-shadow:0 6px 20px var(--shadow)}</span></p><p class="c1"><span class="c0">&nbsp; .btn:active{transform:translateY(1px)}</span></p><p class="c1"><span class="c0">&nbsp; #startOverlay,#gameOver{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,.85));z-index:10;text-align:center;padding:24px}</span></p><p class="c1"><span class="c0">&nbsp; .card{max-width:720px;background:rgba(255,255,255,.08);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:20px 18px 16px;box-shadow:0 30px 80px rgba(0,0,0,.5)}</span></p><p class="c1"><span class="c0">&nbsp; .title{font-size:28px;margin:4px 0 10px;font-weight:900;letter-spacing:.5px}</span></p><p class="c1"><span class="c0">&nbsp; .subtitle{opacity:.9;margin-bottom:16px}</span></p><p class="c1"><span class="c0">&nbsp; .kbd{display:inline-block;background:rgba(255,255,255,.12);padding:2px 8px;border-radius:6px;font-weight:800}</span></p><p class="c1"><span class="c0">&nbsp; .primary{background:linear-gradient(180deg,#ff6db5,#ff2d7a);color:#fff;border:none;border-radius:12px;padding:12px 18px;font-size:18px;font-weight:900;cursor:pointer}</span></p><p class="c1"><span class="c0">&nbsp; #toast{position:fixed;left:50%;bottom:22vh;transform:translateX(-50%);z-index:7;font-weight:900;letter-spacing:.4px;text-shadow:0 2px 10px rgba(0,0,0,.6);pointer-events:none;font-size:18px}</span></p><p class="c1"><span class="c0">&nbsp; #touch{position:fixed;inset:auto 0 0 0;padding:8px 12px 14px;display:flex;justify-content:space-between;align-items:flex-end;gap:12px;z-index:6;pointer-events:none}</span></p><p class="c1"><span class="c0">&nbsp; .pad{pointer-events:auto;display:grid;grid-template-areas:&quot;. up .&quot;&quot;left . right&quot;&quot;. down .&quot;;gap:10px;place-items:center}</span></p><p class="c1"><span class="c0">&nbsp; .ctl{width:68px;height:68px;border-radius:14px;border:none;font-size:28px;font-weight:900;background:rgba(255,255,255,.14);color:#fff;box-shadow:0 10px 30px var(--shadow)}</span></p><p class="c1"><span class="c0">&nbsp; .ctl:active{transform:translateY(2px)} .up{grid-area:up}.down{grid-area:down}.left{grid-area:left}.right{grid-area:right}</span></p><p class="c1"><span class="c0">&nbsp; .help{opacity:.85;font-size:12px;margin-top:6px}</span></p><p class="c1"><span class="c0">&nbsp; @media (min-width:900px){#touch{display:none}}</span></p><p class="c1"><span class="c0">&lt;/style&gt;</span></p><p class="c1"><span class="c0">&lt;/head&gt;</span></p><p class="c1"><span class="c0">&lt;body&gt;</span></p><p class="c1"><span class="c0">&lt;canvas id=&quot;game&quot;&gt;&lt;/canvas&gt;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&lt;div id=&quot;hud&quot;&gt;</span></p><p class="c1"><span class="c0">&nbsp; &lt;div class=&quot;row&quot;&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;div class=&quot;pill&quot;&gt;Score: &lt;b id=&quot;score&quot;&gt;0&lt;/b&gt;&lt;/div&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;div class=&quot;pill&quot;&gt;Best: &lt;b id=&quot;best&quot;&gt;0&lt;/b&gt;&lt;/div&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;div class=&quot;pill&quot;&gt;Misses: &lt;b id=&quot;misses&quot;&gt;0&lt;/b&gt;/2&lt;/div&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;div id=&quot;envTag&quot;&gt;City&lt;/div&gt;</span></p><p class="c1"><span class="c0">&nbsp; &lt;/div&gt;</span></p><p class="c1"><span class="c0">&lt;/div&gt;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&lt;div id=&quot;buttons&quot;&gt;</span></p><p class="c1"><span class="c0">&nbsp; &lt;button id=&quot;pauseBtn&quot; class=&quot;btn&quot;&gt;Pause&lt;/button&gt;</span></p><p class="c1"><span class="c0">&nbsp; &lt;button id=&quot;muteBtn&quot; class=&quot;btn&quot;&gt;Music: On&lt;/button&gt;</span></p><p class="c1"><span class="c0">&lt;/div&gt;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&lt;div id=&quot;touch&quot;&gt;</span></p><p class="c1"><span class="c0">&nbsp; &lt;div&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;div class=&quot;pad&quot; id=&quot;dpad&quot;&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &lt;button class=&quot;ctl up&quot; data-dir=&quot;up&quot;&gt;&#9650;&lt;/button&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &lt;button class=&quot;ctl left&quot; data-dir=&quot;left&quot;&gt;&#9664;&lt;/button&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &lt;button class=&quot;ctl right&quot; data-dir=&quot;right&quot;&gt;&#9654;&lt;/button&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &lt;button class=&quot;ctl down&quot; data-dir=&quot;down&quot;&gt;&#9660;&lt;/button&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;/div&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;div class=&quot;help&quot;&gt;Use arrows to steer the taxi&lt;/div&gt;</span></p><p class="c1"><span class="c0">&nbsp; &lt;/div&gt;</span></p><p class="c1"><span class="c0">&nbsp; &lt;button id=&quot;pauseBig&quot; class=&quot;btn&quot; style=&quot;pointer-events:auto;height:68px&quot;&gt;&#9199; Pause&lt;/button&gt;</span></p><p class="c1"><span class="c0">&lt;/div&gt;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&lt;div id=&quot;toast&quot;&gt;&lt;/div&gt;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&lt;div id=&quot;startOverlay&quot; role=&quot;dialog&quot; aria-modal=&quot;true&quot;&gt;</span></p><p class="c1"><span class="c0">&nbsp; &lt;div class=&quot;card&quot;&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;div class=&quot;title&quot;&gt;OBER &mdash; Angry Taxi&lt;/div&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;div class=&quot;subtitle&quot;&gt;Dodge traffic &amp; obstacles, &lt;b&gt;pick up passengers&lt;/b&gt; (miss two in a row &rarr; game over). &#127819; = 3s invincible turbo. Patrice = 3s shooting.&lt;/div&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;ul style=&quot;text-align:left;line-height:1.55;margin:0 0 14px 0;padding-left:18px&quot;&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &lt;li&gt;&lt;b&gt;Keyboard:&lt;/b&gt; Arrows/WASD &bull; &lt;span class=&quot;kbd&quot;&gt;Space&lt;/span&gt; start &bull; &lt;span class=&quot;kbd&quot;&gt;P&lt;/span&gt; pause &bull; &lt;span class=&quot;kbd&quot;&gt;M&lt;/span&gt; music&lt;/li&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &lt;li&gt;&lt;b&gt;Mobile:&lt;/b&gt; Use the on-screen arrows&lt;/li&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &lt;li&gt;&lt;b&gt;Environments:&lt;/b&gt; City &rarr; Desert &rarr; Space &rarr; Underwater &rarr; Futuristic (25s each)&lt;/li&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;/ul&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;button id=&quot;startBtn&quot; class=&quot;primary&quot;&gt;&#9654; Start&lt;/button&gt;</span></p><p class="c1"><span class="c0">&nbsp; &lt;/div&gt;</span></p><p class="c1"><span class="c0">&lt;/div&gt;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&lt;div id=&quot;gameOver&quot; hidden&gt;</span></p><p class="c1"><span class="c0">&nbsp; &lt;div class=&quot;card&quot;&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;div class=&quot;title&quot;&gt;Game Over&lt;/div&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;div id=&quot;reason&quot; class=&quot;subtitle&quot;&gt;&lt;/div&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;div style=&quot;display:flex;gap:10px;justify-content:center&quot;&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &lt;button id=&quot;restartBtn&quot; class=&quot;primary&quot;&gt;&#8635; Restart&lt;/button&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &lt;button id=&quot;closeBtn&quot; class=&quot;btn&quot;&gt;Close&lt;/button&gt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &lt;/div&gt;</span></p><p class="c1"><span class="c0">&nbsp; &lt;/div&gt;</span></p><p class="c1"><span class="c0">&lt;/div&gt;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&lt;script&gt;</span></p><p class="c1"><span class="c0">(function(){</span></p><p class="c1"><span class="c0">&nbsp; &#39;use strict&#39;;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; const canvas = document.getElementById(&#39;game&#39;);</span></p><p class="c1"><span class="c0">&nbsp; const ctx = canvas.getContext(&#39;2d&#39;);</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Retina fit</span></p><p class="c1"><span class="c0">&nbsp; let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));</span></p><p class="c1"><span class="c0">&nbsp; function resize(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const w = innerWidth, h = innerHeight;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; canvas.width = Math.floor(w*DPR); canvas.height = Math.floor(h*DPR);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; canvas.style.width = w+&#39;px&#39;; canvas.style.height = h+&#39;px&#39;;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.setTransform(DPR,0,0,DPR,0,0);</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; resize(); addEventListener(&#39;resize&#39;, resize);</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // UI refs</span></p><p class="c1"><span class="c0">&nbsp; const $score = document.getElementById(&#39;score&#39;), $best = document.getElementById(&#39;best&#39;);</span></p><p class="c1"><span class="c0">&nbsp; const $misses = document.getElementById(&#39;misses&#39;), $envTag = document.getElementById(&#39;envTag&#39;);</span></p><p class="c1"><span class="c0">&nbsp; const $toast = document.getElementById(&#39;toast&#39;), $pauseBtn = document.getElementById(&#39;pauseBtn&#39;);</span></p><p class="c1"><span class="c0">&nbsp; const $muteBtn = document.getElementById(&#39;muteBtn&#39;), $pauseBig = document.getElementById(&#39;pauseBig&#39;);</span></p><p class="c1"><span class="c0">&nbsp; const $startOverlay = document.getElementById(&#39;startOverlay&#39;), $startBtn = document.getElementById(&#39;startBtn&#39;);</span></p><p class="c1"><span class="c0">&nbsp; const $gameOver = document.getElementById(&#39;gameOver&#39;), $restartBtn = document.getElementById(&#39;restartBtn&#39;);</span></p><p class="c1"><span class="c0">&nbsp; const $closeBtn = document.getElementById(&#39;closeBtn&#39;), $reason = document.getElementById(&#39;reason&#39;);</span></p><p class="c1"><span class="c0">&nbsp; const $dpad = document.getElementById(&#39;dpad&#39;);</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Input</span></p><p class="c1"><span class="c0">&nbsp; const keys = {up:false,down:false,left:false,right:false};</span></p><p class="c1"><span class="c0">&nbsp; function clearInput(){ keys.up=keys.down=keys.left=keys.right=false; }</span></p><p class="c1"><span class="c0">&nbsp; addEventListener(&#39;keydown&#39;,e=&gt;{</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if([&#39;ArrowUp&#39;,&#39;ArrowDown&#39;,&#39;ArrowLeft&#39;,&#39;ArrowRight&#39;,&#39; &#39;].includes(e.key)) e.preventDefault();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(e.key===&#39;ArrowUp&#39;||e.key===&#39;w&#39;||e.key===&#39;W&#39;) keys.up=true;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; else if(e.key===&#39;ArrowDown&#39;||e.key===&#39;s&#39;||e.key===&#39;S&#39;) keys.down=true;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; else if(e.key===&#39;ArrowLeft&#39;||e.key===&#39;a&#39;||e.key===&#39;A&#39;) keys.left=true;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; else if(e.key===&#39;ArrowRight&#39;||e.key===&#39;d&#39;||e.key===&#39;D&#39;) keys.right=true;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; else if(e.key===&#39; &#39;) startGame();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; else if(e.key===&#39;p&#39;||e.key===&#39;P&#39;) togglePause();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; else if(e.key===&#39;m&#39;||e.key===&#39;M&#39;) toggleMusic();</span></p><p class="c1"><span class="c0">&nbsp; });</span></p><p class="c1"><span class="c0">&nbsp; addEventListener(&#39;keyup&#39;,e=&gt;{</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(e.key===&#39;ArrowUp&#39;||e.key===&#39;w&#39;||e.key===&#39;W&#39;) keys.up=false;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; else if(e.key===&#39;ArrowDown&#39;||e.key===&#39;s&#39;||e.key===&#39;S&#39;) keys.down=false;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; else if(e.key===&#39;ArrowLeft&#39;||e.key===&#39;a&#39;||e.key===&#39;A&#39;) keys.left=false;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; else if(e.key===&#39;ArrowRight&#39;||e.key===&#39;d&#39;||e.key===&#39;D&#39;) keys.right=false;</span></p><p class="c1"><span class="c0">&nbsp; });</span></p><p class="c1"><span class="c0">&nbsp; const touchMap = new Map();</span></p><p class="c1"><span class="c0">&nbsp; function onPad(e){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const btn = e.target.closest(&#39;.ctl&#39;); if(!btn) return;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const dir = btn.dataset.dir;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(e.type===&#39;pointerdown&#39;){ btn.setPointerCapture?.(e.pointerId); touchMap.set(e.pointerId,dir); keys[dir]=true; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; else if(e.type===&#39;pointerup&#39; || e.type===&#39;pointercancel&#39; || e.type===&#39;pointerleave&#39;){ const d=touchMap.get(e.pointerId); if(d){ keys[d]=false; touchMap.delete(e.pointerId);} }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; e.preventDefault();</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; [&#39;pointerdown&#39;,&#39;pointerup&#39;,&#39;pointercancel&#39;,&#39;pointerleave&#39;].forEach(t=&gt; $dpad.addEventListener(t,onPad,{passive:false}));</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Buttons</span></p><p class="c1"><span class="c0">&nbsp; $pauseBtn.onclick = togglePause;</span></p><p class="c1"><span class="c0">&nbsp; $pauseBig.onclick = togglePause;</span></p><p class="c1"><span class="c0">&nbsp; $muteBtn.onclick = toggleMusic;</span></p><p class="c1"><span class="c0">&nbsp; $startBtn.onclick = startGame;</span></p><p class="c1"><span class="c0">&nbsp; $restartBtn.onclick = ()=&gt;{ hide($gameOver); startGame(); };</span></p><p class="c1"><span class="c0">&nbsp; $closeBtn.onclick = ()=&gt;{ hide($gameOver); show($startOverlay); };</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Utils</span></p><p class="c1"><span class="c0">&nbsp; function show(el){ el.hidden=false; el.style.display=&#39;flex&#39;; }</span></p><p class="c1"><span class="c0">&nbsp; function hide(el){ el.hidden=true; el.style.display=&#39;none&#39;; }</span></p><p class="c1"><span class="c0">&nbsp; function clamp(v,min,max){ return Math.max(min, Math.min(max,v)) }</span></p><p class="c1"><span class="c0">&nbsp; function lerp(a,b,t){ return a+(b-a)*t }</span></p><p class="c1"><span class="c0">&nbsp; function rand(a,b){ return a+Math.random()*(b-a) }</span></p><p class="c1"><span class="c0">&nbsp; function choice(a){ return a[(Math.random()*a.length)|0] }</span></p><p class="c1"><span class="c0">&nbsp; function toast(text,color=&#39;#fff&#39;){ $toast.textContent=text; $toast.style.color=color; toast.until = performance.now()+1400; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Environments</span></p><p class="c1"><span class="c0">&nbsp; const ENV = [</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; {name:&#39;City&#39;, sky:&#39;#0b1020&#39;, road:&#39;#2a2e39&#39;, edge:&#39;#141821&#39;, stripe:&#39;#f7f7f7&#39;, fog:&#39;rgba(11,16,32,0.35)&#39;, deco:&#39;#6ee7ff&#39;},</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; {name:&#39;Desert&#39;, sky:&#39;#1e1409&#39;, road:&#39;#6b4b2a&#39;, edge:&#39;#3e2c17&#39;, stripe:&#39;#fff3c4&#39;, fog:&#39;rgba(30,20,9,0.35)&#39;, deco:&#39;#ffe08a&#39;},</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; {name:&#39;Space&#39;, sky:&#39;#000006&#39;, road:&#39;#242424&#39;, edge:&#39;#101010&#39;, stripe:&#39;#d8f0ff&#39;, fog:&#39;rgba(0,0,6,0.4)&#39;, deco:&#39;#9fe3ff&#39;},</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; {name:&#39;Underwater&#39;, sky:&#39;#05131b&#39;, road:&#39;#1b3a4b&#39;, edge:&#39;#0d2330&#39;, stripe:&#39;#d6fff9&#39;, fog:&#39;rgba(5,19,27,0.45)&#39;, deco:&#39;#72f1ff&#39;},</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; {name:&#39;Futuristic&#39;, sky:&#39;#04040e&#39;, road:&#39;#1a1a2e&#39;, edge:&#39;#0d0d1a&#39;, stripe:&#39;#9affff&#39;, fog:&#39;rgba(4,4,14,0.40)&#39;, deco:&#39;#5ef2ff&#39;},</span></p><p class="c1"><span class="c0">&nbsp; ];</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; const NAMES = [&quot;Steve&quot;,&quot;Butterboots&quot;,&quot;Laura&quot;,&quot;Olivia&quot;,&quot;Caoimhe&quot;,&quot;HughSmells&quot;,&quot;Fionnuala&quot;,&quot;Richard&quot;,&quot;Lorna&quot;,&quot;Killian&quot;,&quot;Helen&quot;,&quot;Bill&quot;,&quot;Colm&quot;];</span></p><p class="c1"><span class="c0">&nbsp; const LANE_COUNT = 4;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Audio (original single loop)</span></p><p class="c1"><span class="c0">&nbsp; let AC=null, master, musicOn=true, musicStarted=false, sched;</span></p><p class="c1"><span class="c0">&nbsp; const music = {bpm:136, step:0, next:0};</span></p><p class="c1"><span class="c0">&nbsp; function audioInit(){ if(AC) return; const A = window.AudioContext||window.webkitAudioContext; if(!A) return; AC=new A(); master=AC.createGain(); master.gain.value=0.28; master.connect(AC.destination); buildDrums(); buildBuses(); }</span></p><p class="c1"><span class="c0">&nbsp; let kick, snare, hat, bass, pad, lead;</span></p><p class="c1"><span class="c0">&nbsp; function buildDrums(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; kick=(t)=&gt;{ const o=AC.createOscillator(), g=AC.createGain(); o.frequency.setValueAtTime(150,t); o.frequency.exponentialRampToValueAtTime(45,t+0.12); g.gain.setValueAtTime(0.8,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.18); o.connect(g); g.connect(master); o.start(t); o.stop(t+0.2); };</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const noiseBuf=(()=&gt;{ const b=AC.createBuffer(1,AC.sampleRate*0.2,AC.sampleRate); const d=b.getChannelData(0); for(let i=0;i&lt;d.length;i++) d[i]=Math.random()*2-1; return b;})();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; snare=(t)=&gt;{ const s=AC.createBufferSource(); s.buffer=noiseBuf; const b=AC.createBiquadFilter(); b.type=&#39;highpass&#39;; b.frequency.value=1800; const g=AC.createGain(); g.gain.setValueAtTime(0.25,t); g.gain.exponentialRampToValueAtTime(0.00001,t+0.12); s.connect(b); b.connect(g); g.connect(master); s.start(t); s.stop(t+0.2); };</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; hat=(t)=&gt;{ const s=AC.createBufferSource(); const b=AC.createBuffer(1,AC.sampleRate*0.05,AC.sampleRate); const d=b.getChannelData(0); for(let i=0;i&lt;d.length;i++) d[i]=(Math.random()*2-1)*0.8; s.buffer=b; const f=AC.createBiquadFilter(); f.type=&#39;highpass&#39;; f.frequency.value=7000; const g=AC.createGain(); g.gain.setValueAtTime(0.15,t); g.gain.exponentialRampToValueAtTime(0.00001,t+0.05); s.connect(f); f.connect(g); g.connect(master); s.start(t); s.stop(t+0.06); };</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function buildBuses(){ bass={g:AC.createGain()}; pad={g:AC.createGain()}; lead={g:AC.createGain()}; bass.g.gain.value=0.28; pad.g.gain.value=0.14; lead.g.gain.value=0.2; bass.g.connect(master); pad.g.connect(master); lead.g.connect(master); }</span></p><p class="c1"><span class="c0">&nbsp; function note(freq, len, t, dest, type=&#39;sawtooth&#39;){ const o=AC.createOscillator(), g=AC.createGain(); o.type=type; o.frequency.setValueAtTime(freq,t); g.gain.setValueAtTime(0.001,t); g.gain.linearRampToValueAtTime(0.35,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+len); o.connect(g); g.connect(dest); o.start(t); o.stop(t+len+0.05); }</span></p><p class="c1"><span class="c0">&nbsp; function chord(f, t){ note(f,0.4,t,pad.g,&#39;sawtooth&#39;); note(f*1.25,0.4,t,pad.g,&#39;sawtooth&#39;); note(f*1.5,0.4,t,pad.g,&#39;sawtooth&#39;); }</span></p><p class="c1"><span class="c0">&nbsp; function startMusic(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(musicStarted) return; audioInit(); if(!AC) return; if(AC.state===&#39;suspended&#39;) AC.resume();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const stepDur=60/music.bpm/4, look=0.1; music.next=AC.currentTime+0.05;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; sched=setInterval(()=&gt;{ const ct=AC.currentTime; while(music.next&lt;ct+look){ scheduleStep(music.step, music.next); music.step=(music.step+1)%64; music.next+=stepDur; } },25);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; musicStarted=true;</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function scheduleStep(step,t){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const beat=step%16, bar=(step/16)|0;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(beat===0||beat===8) kick(t);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(beat===4||beat===12) snare(t);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if([1,3,5,7,9,11,13,15].includes(beat)) hat(t);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const root = [110,98,130,87][bar%4];</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(beat===0) chord(root,t);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const bassFreqs = [root, root*1.5, root*1.25, root*1.5];</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const bf = bassFreqs[(beat/4)|0];</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(beat%4===0) note(bf,0.23,t,bass.g,&#39;square&#39;);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const scale=[261.63,293.66,311.13,349.23,392.0,415.3,466.16];</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const phrase=[0,3,5,7,5,3,2,0];</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(beat%2===0){ const idx=phrase[(beat/2)%phrase.length]; const f=scale[idx%scale.length]*(bar%2?1:2); note(f,0.15,t,lead.g,&#39;triangle&#39;); }</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function toggleMusic(){ const on = (master?.gain?.value||0)&gt;0 ? false : true; if(on){ master.gain.value=0.28; } else { master.gain.value=0; } $muteBtn.textContent=&#39;Music: &#39;+(on?&#39;On&#39;:&#39;Off&#39;); }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Game state</span></p><p class="c1"><span class="c0">&nbsp; const state = {</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; status:&#39;idle&#39;, t:0, dt:0, last:0,</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; score:0, best:+localStorage.getItem(&#39;ober_best&#39;)||0, misses:0,</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; envIndex:0, envTime:0, envSwapEvery:25,</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; worldSpeed:260, // slightly slower start; ramps up</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; roadWidth:0,</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Speed boosts: base * 1.33 * 1.33 * 1.33 &asymp; 2.35x, accel &asymp; 1.77x</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; player:{x:0,y:0,w:50,h:86,vx:0,vy:0,maxVx:340*2.352, maxVy:280*2.352, accel:1200*1.77, invUntil:0, turboUntil:0, stinkUntil:0, speechUntil:0, quipNext:0, quipFlip:false, shootUntil:0, shootTimer:0},</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; items:{cars:[],obstacles:[],passengers:[],lemons:[],patrice:[],bullets:[],deco:[]},</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; spawn:{car:0,ob:0,pass:1.5,lem:10+Math.random()*10,pat:16+Math.random()*12},</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; carSpawnScale:1.15, // 15% fewer cars</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; lastPassengerSpawnAt: performance.now()</span></p><p class="c1"><span class="c0">&nbsp; };</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Start/Pause/Restart</span></p><p class="c1"><span class="c0">&nbsp; function startGame(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(state.status===&#39;playing&#39;) return;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; hide($startOverlay); hide($gameOver);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; startMusic();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; reset();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.status=&#39;playing&#39;;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; toast(&#39;Go!&#39;,&#39;var(--good)&#39;);</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function togglePause(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(state.status===&#39;playing&#39;){ state.status=&#39;paused&#39;; toast(&#39;Paused&#39;); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; else if(state.status===&#39;paused&#39;){ state.last=performance.now(); state.status=&#39;playing&#39;; toast(&#39;Go!&#39;); }</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function reset(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.t=0; state.dt=0; state.last=0; state.score=0; state.misses=0;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.envIndex=0; state.envTime=0; state.worldSpeed=260;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.items={cars:[],obstacles:[],passengers:[],lemons:[],patrice:[],bullets:[],deco:[]};</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.spawn={car:0,ob:0,pass:1.2,lem:8+Math.random()*10,pat:14+Math.random()*12};</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const W=canvas.clientWidth,H=canvas.clientHeight;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.player.x=W/2; state.player.y=H*0.78;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.player.vx=state.player.vy=0;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.player.invUntil=0; state.player.turboUntil=0; state.player.stinkUntil=0; state.player.speechUntil=0;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.player.shootUntil=0; state.player.shootTimer=0;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.player.quipNext=performance.now()+10000; state.player.quipFlip=false;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.lastPassengerSpawnAt = performance.now();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.roadWidth = Math.min(640, Math.max(340, W*0.72));</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; clearInput(); updateUI();</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Quips</span></p><p class="c1"><span class="c0">&nbsp; const quips = { text:&#39;&#39; };</span></p><p class="c1"><span class="c0">&nbsp; function scheduleQuips(now){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(now &gt;= state.player.quipNext &amp;&amp; state.status===&#39;playing&#39;){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; quips.text = state.player.quipFlip ? &#39;Not too bad&#39; : &#39;SLOW C*NTS&#39;;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; state.player.quipFlip = !state.player.quipFlip;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; state.player.speechUntil = now + 1800;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; state.player.quipNext = now + 10000 + Math.random()*1500;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Spawning helpers</span></p><p class="c1"><span class="c0">&nbsp; function laneX(l){ const W=canvas.clientWidth; const sway=Math.sin(state.t*0.6)*42 + Math.sin(state.t*0.27)*24; const left=(W-state.roadWidth)/2 + sway; const laneW=state.roadWidth/LANE_COUNT; return left + l*laneW + laneW/2; }</span></p><p class="c1"><span class="c0">&nbsp; function pickSafePassengerLane(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const spawnY = -60;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const SAFE_Y = 220;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const busy = new Set();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(const c of state.items.cars){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(Math.abs(c.y - spawnY) &lt; SAFE_Y){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; busy.add(c.l);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; if(c.l&gt;0) busy.add(c.l-1);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; if(c.l&lt;LANE_COUNT-1) busy.add(c.l+1);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const safe=[]; for(let l=0;l&lt;LANE_COUNT;l++){ if(!busy.has(l)) safe.push(l); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(safe.length) return choice(safe);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // fallback: farthest</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; let best=0,score=-1; for(let l=0;l&lt;LANE_COUNT;l++){ let s=0; for(const c of state.items.cars){ s=Math.max(s,Math.abs(l-c.l)); } if(s&gt;score){ score=s; best=l; } }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; return best;</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; function spawnCar(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const l=(Math.random()*LANE_COUNT)|0;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.items.cars.push({x:laneX(l), y:-120, w:56, h:96, l, spd:state.worldSpeed*rand(0.75,1.2), col:`hsl(${(Math.random()*360)|0} 85% 62%)`});</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function spawnOb(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const l=(Math.random()*LANE_COUNT)|0;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const cone=Math.random()&lt;0.5;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.items.obstacles.push({x:laneX(l), y:-80, w:cone?34:60, h:cone?50:40, l, cone});</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function spawnPassenger(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const l = pickSafePassengerLane();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.items.passengers.push({x:laneX(l), y:-60, w:26, h:44, l, name:choice(NAMES), missed:false});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.lastPassengerSpawnAt = performance.now();</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function spawnLemon(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const l=(Math.random()*LANE_COUNT)|0;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.items.lemons.push({x:laneX(l), y:-60, w:30, h:30, l});</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function spawnPatrice(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const l=(Math.random()*LANE_COUNT)|0;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Long brown tube ~2x size</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.items.patrice.push({x:laneX(l), y:-60, w:64, h:24, l});</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function spawnDeco(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const y=-10, W=canvas.clientWidth, env=ENV[state.envIndex].name;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(env===&#39;City&#39;){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; state.items.deco.push({k:&#39;window&#39;,x:rand(20,W-20),y});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(Math.random()&lt;0.2) state.items.deco.push({k:&#39;billboard&#39;,x:rand(30,W-30),y});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; } else if(env===&#39;Desert&#39;){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; state.items.deco.push({k:&#39;cactus&#39;,x:rand(18,W-18),y});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(Math.random()&lt;0.1) state.items.deco.push({k:&#39;sun&#39;,x:rand(30,W-30),y});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; } else if(env===&#39;Space&#39;){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; state.items.deco.push({k:&#39;star&#39;,x:rand(10,W-10),y,r:rand(1,2.2)});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(Math.random()&lt;0.12) state.items.deco.push({k:&#39;planet&#39;,x:rand(20,W-20),y,r:rand(8,16)});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(Math.random()&lt;0.05) state.items.deco.push({k:&#39;comet&#39;,x:rand(10,W-10),y,vx:rand(-40,40)});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; } else if(env===&#39;Underwater&#39;){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(Math.random()&lt;0.7) state.items.deco.push({k:&#39;bubble&#39;,x:rand(10,W-10),y,r:rand(3,8)});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(Math.random()&lt;0.25) state.items.deco.push({k:&#39;fish&#39;,x:rand(20,W-20),y,vx:rand(-20,20)});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(Math.random()&lt;0.2) state.items.deco.push({k:&#39;weed&#39;,x:rand(20,W-20),y});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; } else { // Futuristic</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; state.items.deco.push({k:&#39;holo&#39;,x:rand(20,W-20),y});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(Math.random()&lt;0.25) state.items.deco.push({k:&#39;drone&#39;,x:rand(20,W-20),y,vx:rand(-25,25)});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(Math.random()&lt;0.2) state.items.deco.push({k:&#39;beam&#39;,x:rand(20,W-20),y});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Collision</span></p><p class="c1"><span class="c0">&nbsp; function hit(a,b){ return Math.abs(a.x-b.x)&lt;(a.w+b.w)/2 &amp;&amp; Math.abs(a.y-b.y)&lt;(a.h+b.h)/2 }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Loop (always runs)</span></p><p class="c1"><span class="c0">&nbsp; requestAnimationFrame(loop);</span></p><p class="c1"><span class="c0">&nbsp; function loop(now){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(!state.last) state.last=now;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.dt=Math.min(0.033,(now-state.last)/1000); state.last=now;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(state.status===&#39;playing&#39;){ update(now); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; draw(); // draw every frame so overlays/toast render</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; updateUI();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if($toast.textContent &amp;&amp; now&gt;toast.until){ $toast.textContent=&#39;&#39;; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; requestAnimationFrame(loop);</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; function endGame(reason){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.best = Math.max(state.best, Math.floor(state.score));</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; localStorage.setItem(&#39;ober_best&#39;, state.best);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; $reason.textContent = reason;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; show($gameOver);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.status=&#39;over&#39;;</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Update</span></p><p class="c1"><span class="c0">&nbsp; function update(nowMs){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.t += state.dt; state.envTime += state.dt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(state.envTime&gt;=state.envSwapEvery){ state.envTime=0; state.envIndex=(state.envIndex+1)%ENV.length; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Slight speed ramp</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.worldSpeed += state.dt*3.5;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Spawns (car rate reduced 15%)</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.spawn.car -= state.dt; if(state.spawn.car&lt;=0){ spawnCar(); state.spawn.car = (rand(0.38,0.9))*state.carSpawnScale; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.spawn.ob &nbsp;-= state.dt; if(state.spawn.ob&lt;=0){ if(Math.random()&lt;0.55) spawnOb(); state.spawn.ob = rand(1.2,2.4); }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Passenger &mdash; normal cadence OR watchdog (12s max gap)</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.spawn.pass -= state.dt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(state.items.passengers.length===0){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(state.spawn.pass&lt;=0 || (nowMs - state.lastPassengerSpawnAt) &gt; 12000){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; spawnPassenger();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; state.spawn.pass = rand(4.5,8.5);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.spawn.lem -= state.dt; if(state.spawn.lem&lt;=0){ spawnLemon(); state.spawn.lem = 10 + Math.random()*14; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.spawn.pat -= state.dt; if(state.spawn.pat&lt;=0){ spawnPatrice(); state.spawn.pat = 15 + Math.random()*18; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(Math.random()&lt;0.25) spawnDeco();</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Player movement</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const p=state.player;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const boost=(p.turboUntil&gt;nowMs)?1.6:1, inv=(p.invUntil&gt;nowMs);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const ax=(keys.left?-1:0)+(keys.right?1:0), ay=(keys.up?-1:0)+(keys.down?1:0);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; p.vx += ax*p.accel*state.dt; p.vy += ay*p.accel*state.dt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const maxVx=p.maxVx*boost; p.vx=clamp(p.vx,-maxVx,maxVx); p.vy=clamp(p.vy,-p.maxVy,p.maxVy);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; p.vx*=0.86; p.vy*=0.86;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; p.x+=p.vx*state.dt; p.y+=p.vy*state.dt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const W=canvas.clientWidth,H=canvas.clientHeight; const sway=Math.sin(state.t*0.6)*42 + Math.sin(state.t*0.27)*24;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const left=(W-state.roadWidth)/2 + sway, right=left+state.roadWidth;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; p.x=clamp(p.x,left+40,right-40); p.y=clamp(p.y,H*0.35,H-60);</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Scroll world</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const scroll=state.worldSpeed*state.dt*boost;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(const c of state.items.cars){ c.y+=scroll + (c.spd-state.worldSpeed)*state.dt; c.x += (laneX(c.l)-c.x)*0.06; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(const o of state.items.obstacles){ o.y+=scroll; o.x += (laneX(o.l)-o.x)*0.06; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(const g of state.items.passengers){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; g.y+=scroll*0.9; g.x += (laneX(g.l)-g.x)*0.06;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(!g.missed &amp;&amp; g.y&gt;H+60){ g.missed=true; state.misses++; toast(&#39;Missed &#39;+g.name,&#39;var(--bad)&#39;); if(state.misses&gt;=2){ endGame(&#39;You missed two passengers in a row.&#39;); return; } }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(const lem of state.items.lemons){ lem.y+=scroll; lem.x += (laneX(lem.l)-lem.x)*0.06; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(const t of state.items.patrice){ t.y+=scroll; t.x += (laneX(t.l)-t.x)*0.06; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(const d of state.items.deco){ d.y+=scroll*(ENV[state.envIndex].name===&#39;Underwater&#39;?0.5:0.9); if(d.k===&#39;fish&#39;||d.k===&#39;drone&#39;||d.k===&#39;comet&#39;){ d.x+= (d.vx||0)*state.dt; } }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Score</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; state.score += state.dt*(10 + (boost&gt;1?6:0));</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Collisions</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Cars</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(let i=state.items.cars.length-1;i&gt;=0;i--){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const c=state.items.cars[i];</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(hit(p,c)){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; if(inv){ state.items.cars.splice(i,1); toast(&#39;Bumped (invincible!)&#39;,&#39;var(--good)&#39;); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; else { endGame(&#39;You crashed into traffic.&#39;); return; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(c.y&gt;H+140) state.items.cars.splice(i,1);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Obstacles</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(let i=state.items.obstacles.length-1;i&gt;=0;i--){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const o=state.items.obstacles[i];</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(hit(p,o)){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; if(inv){ state.items.obstacles.splice(i,1); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; else { endGame(&#39;You hit an obstacle.&#39;); return; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(o.y&gt;H+100) state.items.obstacles.splice(i,1);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Passengers</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(let i=state.items.passengers.length-1;i&gt;=0;i--){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const g=state.items.passengers[i];</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(hit(p,g)){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; state.items.passengers.splice(i,1);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; state.misses=0; state.score+=30;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; const special = g.name===&#39;HughSmells&#39;;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; toast(&#39;Picked up &#39;+g.name, special ? &#39;#ffa84d&#39;:&#39;var(--good)&#39;);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; if(special){ p.stinkUntil=nowMs+3500; p.speechUntil=nowMs+2000; quips.text=&#39;Aaahhh that stinks&#39;; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Lemons</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(let i=state.items.lemons.length-1;i&gt;=0;i--){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const lem=state.items.lemons[i];</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(hit(p,lem)){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; state.items.lemons.splice(i,1);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; const end=nowMs+3000; p.invUntil=Math.max(p.invUntil,end); p.turboUntil=Math.max(p.turboUntil,end);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; toast(&#39;&#127819; LEMON TURBO!&#39;,&#39;var(--good)&#39;);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(lem.y&gt;H+100) state.items.lemons.splice(i,1);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Patrice pickup</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(let i=state.items.patrice.length-1;i&gt;=0;i--){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const t=state.items.patrice[i];</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(hit(p,t)){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; state.items.patrice.splice(i,1);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; p.shootUntil = nowMs+3000; p.shootTimer=0;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; p.speechUntil = nowMs+1500; quips.text=&#39;Patrice online&#39;;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; toast(&#39;Patrice ready&#39;,&#39;var(--good)&#39;);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(t.y&gt;H+100) state.items.patrice.splice(i,1);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Shooting (auto while active)</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(p.shootUntil&gt;nowMs){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; p.shootTimer -= state.dt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(p.shootTimer&lt;=0){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; p.shootTimer = 0.15;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; state.items.bullets.push({x:p.x, y:p.y-60, w:6, h:14, vy:-900});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Bullets update + hit cars/obstacles</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(let i=state.items.bullets.length-1;i&gt;=0;i--){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const b=state.items.bullets[i]; b.y += b.vy*state.dt;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; let removed=false;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; // cars first</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; for(let j=state.items.cars.length-1;j&gt;=0;j--){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; if(hit(b,state.items.cars[j])){ state.items.cars.splice(j,1); removed=true; state.score+=10; break; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; // obstacles next (if not already removed)</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(!removed){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; for(let j=state.items.obstacles.length-1;j&gt;=0;j--){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(hit(b,state.items.obstacles[j])){ state.items.obstacles.splice(j,1); removed=true; state.score+=6; break; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(removed || b.y&lt;-40){ state.items.bullets.splice(i,1); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Quips</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; scheduleQuips(nowMs);</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Draw</span></p><p class="c1"><span class="c0">&nbsp; function draw(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const W=canvas.clientWidth,H=canvas.clientHeight, env=ENV[state.envIndex];</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=env.sky; ctx.fillRect(0,0,W,H);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; drawDecoBack(env);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const sway=Math.sin(state.t*0.6)*42 + Math.sin(state.t*0.27)*24;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const left=(W-state.roadWidth)/2 + sway, laneW=state.roadWidth/LANE_COUNT;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=env.edge; ctx.fillRect(left-18,0,state.roadWidth+36,H);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=env.road; ctx.fillRect(left,0,state.roadWidth,H);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.strokeStyle=env.stripe; ctx.lineWidth=4; ctx.setLineDash([18,18]); ctx.beginPath();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(let i=1;i&lt;LANE_COUNT;i++){ const x=left+i*laneW; ctx.moveTo(x,0); ctx.lineTo(x,H); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.stroke(); ctx.setLineDash([]);</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Entities</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(const c of state.items.cars) drawCar(c.x,c.y,c.w,c.h,c.col,false);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(const o of state.items.obstacles) drawObstacle(o);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(const g of state.items.passengers) drawPassenger(g);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(const lem of state.items.lemons) drawLemon(lem);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(const t of state.items.patrice) drawPatrice(t);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; for(const b of state.items.bullets) drawBullet(b);</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Player last (on top)</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; drawCar(state.player.x,state.player.y,50,86,&#39;#ffd400&#39;,true);</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // Overlay fog</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=env.fog; ctx.fillRect(0,0,W,H);</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Env deco</span></p><p class="c1"><span class="c0">&nbsp; function drawDecoBack(env){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const name=env.name;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(name===&#39;City&#39;){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; ctx.fillStyle=env.deco;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; for(const d of state.items.deco){ if(d.k===&#39;window&#39;){ ctx.globalAlpha=0.7; ctx.fillRect(d.x,d.y,2,8); ctx.globalAlpha=1; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; else if(d.k===&#39;billboard&#39;){ ctx.globalAlpha=0.9; ctx.fillRect(d.x-16,d.y,32,10); ctx.globalAlpha=1; } }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; } else if(name===&#39;Desert&#39;){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; ctx.strokeStyle=env.deco; ctx.lineWidth=3;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; for(const d of state.items.deco){ if(d.k===&#39;cactus&#39;){ const x=d.x,y=d.y; ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x,y+18); ctx.moveTo(x-4,y+5); ctx.lineTo(x,y+9); ctx.moveTo(x+4,y+7); ctx.lineTo(x,y+12); ctx.stroke(); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; else if(d.k===&#39;sun&#39;){ ctx.fillStyle=env.deco; ctx.beginPath(); ctx.arc(d.x,d.y,6,0,Math.PI*2); ctx.fill(); } }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; } else if(name===&#39;Space&#39;){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; for(const d of state.items.deco){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; if(d.k===&#39;star&#39;){ ctx.fillStyle=env.deco; ctx.globalAlpha=0.9; ctx.fillRect(d.x,d.y,d.r,d.r); ctx.globalAlpha=1; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; else if(d.k===&#39;planet&#39;){ ctx.strokeStyle=env.deco; ctx.beginPath(); ctx.arc(d.x,d.y,d.r,0,Math.PI*2); ctx.stroke(); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; else if(d.k===&#39;comet&#39;){ ctx.strokeStyle=env.deco; ctx.beginPath(); ctx.moveTo(d.x,d.y); ctx.lineTo(d.x-(d.vx||20)*0.2, d.y-10); ctx.stroke(); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; } else if(name===&#39;Underwater&#39;){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; for(const d of state.items.deco){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; if(d.k===&#39;bubble&#39;){ ctx.strokeStyle=env.deco; ctx.lineWidth=1; ctx.beginPath(); ctx.arc(d.x,d.y,d.r,0,Math.PI*2); ctx.stroke(); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; else if(d.k===&#39;fish&#39;){ ctx.fillStyle=env.deco; ctx.beginPath(); ctx.ellipse(d.x,d.y,8,4,0,0,Math.PI*2); ctx.fill(); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; else if(d.k===&#39;weed&#39;){ ctx.strokeStyle=env.deco; ctx.beginPath(); ctx.moveTo(d.x,d.y); ctx.lineTo(d.x-4,d.y+14); ctx.lineTo(d.x+2,d.y+22); ctx.stroke(); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; } else { // Futuristic</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; for(const d of state.items.deco){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; if(d.k===&#39;holo&#39;){ ctx.strokeStyle=env.deco; ctx.strokeRect(d.x-10,d.y,20,12); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; else if(d.k===&#39;drone&#39;){ ctx.fillStyle=env.deco; ctx.fillRect(d.x-6,d.y-3,12,6); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; else if(d.k===&#39;beam&#39;){ ctx.strokeStyle=env.deco; ctx.beginPath(); ctx.moveTo(d.x,d.y); ctx.lineTo(d.x,d.y+22); ctx.stroke(); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Drawing helpers</span></p><p class="c1"><span class="c0">&nbsp; function roundRect(x,y,w,h,r,fill){ const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); if(fill){ ctx.fillStyle=fill; ctx.fill(); } }</span></p><p class="c1"><span class="c0">&nbsp; function drawCar(x,y,w,h,color,isPlayer){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // body</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; roundRect(x-w/2,y-h/2,w,h,10,color);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // wheels</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=&#39;#111&#39;; ctx.fillRect(x-w/2+6,y-h/2+10,12,24); ctx.fillRect(x+w/2-18,y-h/2+10,12,24);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillRect(x-w/2+6,y+h/2-34,12,24); ctx.fillRect(x+w/2-18,y+h/2-34,12,24);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // windows</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=&#39;rgba(0,0,0,.55)&#39;; ctx.fillRect(x-w/2+8,y-h/2+16,w-16,26);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // lights</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=&#39;#fff7be&#39;; ctx.fillRect(x-w/2+10,y-h/2+4,12,4); ctx.fillRect(x+w/2-22,y-h/2+4,12,4);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=&#39;#ff2a2a&#39;; ctx.fillRect(x-w/2+10,y+h/2-8,12,4); ctx.fillRect(x+w/2-22,y+h/2-8,12,4);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // roof text only for player</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(isPlayer){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; ctx.fillStyle=&#39;#000&#39;; ctx.font=&#39;900 18px Inter, system-ui, Arial&#39;; ctx.textAlign=&#39;center&#39;; ctx.fillText(&#39;OBER&#39;,x,y-6);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const now=performance.now();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; // flames if turbo</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(state.player.turboUntil&gt;now){ for(let i=0;i&lt;3;i++){ const fx=x+(i-1)*7, len=18+Math.random()*18, col=`hsl(${10+Math.random()*35} 95% ${55+Math.random()*20}%)`; ctx.strokeStyle=col; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(fx,y+h/2); ctx.lineTo(fx+(Math.random()*8-4), y+h/2+len); ctx.stroke(); } }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; // stink lines when HughSmells onboard</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(state.player.stinkUntil&gt;now){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; ctx.strokeStyle=&#39;rgba(145,255,120,.85)&#39;; ctx.lineWidth=2;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; for(let k=0;k&lt;6;k++){ const sx=x+Math.sin((state.t*3)+k)*(w*0.6), sy=y-h/2-8-(k%2?6:0); ctx.beginPath(); ctx.moveTo(sx,sy); ctx.bezierCurveTo(sx-6,sy-10,sx+6,sy-18,sx,sy-26); ctx.stroke(); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; // speech bubble (quips or HughSmells)</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(state.player.speechUntil&gt;now &amp;&amp; quips.text){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; drawSpeechBubble(x, y-h/2-34, quips.text);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; // invincible shimmer</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(state.player.invUntil&gt;now){ ctx.strokeStyle=&#39;rgba(255,255,255,.9)&#39;; ctx.lineWidth=2; ctx.strokeRect(x-w/2-3,y-h/2-3,w+6,h+6); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function drawObstacle(o){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; if(o.cone){ ctx.fillStyle=&#39;#ff7a00&#39;; ctx.beginPath(); ctx.moveTo(o.x,o.y-o.h/2); ctx.lineTo(o.x-o.w/2,o.y+o.h/2); ctx.lineTo(o.x+o.w/2,o.y+o.h/2); ctx.closePath(); ctx.fill(); ctx.fillStyle=&#39;#fff&#39;; ctx.fillRect(o.x-10,o.y+4,20,5); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; else{ roundRect(o.x-o.w/2,o.y-o.h/2,o.w,o.h,6,&#39;#c81d25&#39;); ctx.fillStyle=&#39;#fff&#39;; ctx.fillRect(o.x-o.w/2+8,o.y-4,o.w-16,8); }</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function drawPassenger(g){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // person: pulse ring + body + head</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.strokeStyle=&#39;rgba(255,255,255,.5)&#39;; ctx.beginPath(); ctx.arc(g.x,g.y,20,0,Math.PI*2); ctx.stroke();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; roundRect(g.x-10,g.y-14,20,28,8,&#39;#4ade80&#39;); // body</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=&#39;#ffd2a1&#39;; ctx.beginPath(); ctx.arc(g.x,g.y-20,8,0,Math.PI*2); ctx.fill(); // head</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=&#39;#fff&#39;; ctx.font=&#39;700 14px Inter, system-ui, Arial&#39;; ctx.textAlign=&#39;center&#39;; ctx.fillText(g.name,g.x,g.y-34);</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function drawLemon(lem){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=&#39;#ffe44d&#39;; ctx.beginPath(); ctx.ellipse(lem.x,lem.y,lem.w/2,lem.h/2,0.3,0,Math.PI*2); ctx.fill(); ctx.strokeStyle=&#39;#f7c800&#39;; ctx.lineWidth=2; ctx.stroke();</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=&#39;#2ecc71&#39;; ctx.beginPath(); ctx.ellipse(lem.x+12,lem.y-10,8,4,-0.7,0,Math.PI*2); ctx.fill();</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function drawPatrice(t){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; // long brown tube with caps + label</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=&#39;#7a4a2a&#39;; roundRect(t.x-t.w/2, t.y-t.h/2, t.w, t.h, 12, &#39;#7a4a2a&#39;);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=&#39;#5d371a&#39;; ctx.fillRect(t.x-t.w/2, t.y-t.h/2, 6, t.h);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillRect(t.x+t.w/2-6, t.y-t.h/2, 6, t.h);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=&#39;#fff&#39;; ctx.font=&#39;900 12px Inter, system-ui, Arial&#39;; ctx.textAlign=&#39;center&#39;; ctx.fillText(&#39;Patrice&#39;, t.x, t.y+4);</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function drawBullet(b){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.fillStyle=&#39;#9af0ff&#39;; ctx.fillRect(b.x-b.w/2, b.y-b.h/2, b.w, b.h);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.strokeStyle=&#39;#c8ffff&#39;; ctx.strokeRect(b.x-b.w/2, b.y-b.h/2, b.w, b.h);</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; function drawSpeechBubble(cx,cy,text){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.font=&#39;900 14px Inter, system-ui, Arial&#39;; const pad=8,w=ctx.measureText(text).width+pad*2,h=28,x=cx-w/2,y=cy-h;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; roundRect(x,y,w,h,8,&#39;rgba(0,0,0,.75)&#39;); ctx.fillStyle=&#39;#fff&#39;; ctx.textAlign=&#39;center&#39;; ctx.fillText(text,cx,cy-8);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx-6,cy-8); ctx.lineTo(cx+6,cy-8); ctx.closePath(); ctx.fill();</span></p><p class="c1"><span class="c0">&nbsp; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; function updateUI(){ $score.textContent=Math.floor(state.score); $best.textContent=state.best; $misses.textContent=state.misses; $envTag.textContent=ENV[state.envIndex].name; }</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // Start overlay visible initially</span></p><p class="c1"><span class="c0">&nbsp; show($startOverlay);</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp; // ---- Smoke tests (console) ----</span></p><p class="c1"><span class="c0">&nbsp; (function runSmokeTests(){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; const results=[];</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; function ok(name, cond){ results.push([name, !!cond]); }</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; try{</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; ok(&#39;ENV has 5&#39;, ENV.length===5);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; ok(&#39;drawDecoBack exists&#39;, typeof drawDecoBack===&#39;function&#39;);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const cars0 = state.items.cars.length; spawnCar(); ok(&#39;spawnCar adds car&#39;, state.items.cars.length===cars0+1);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const pass0 = state.items.passengers.length; spawnPassenger(); ok(&#39;spawnPassenger adds passenger&#39;, state.items.passengers.length===pass0+1);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; // Safe lane check: put a car in lane 1 at spawn row; passenger lane should not be 0/1/2 (adjacent)</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; state.items.cars.push({x:laneX(1),y:-60,w:50,h:90,l:1,spd:100});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const testLane = pickSafePassengerLane(); ok(&#39;safe lane avoids car lane &amp; adjacents&#39;, ![0,1,2].includes(testLane));</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; // Patrice spawn &amp; bullets logic</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const pat0=state.items.patrice.length; spawnPatrice(); ok(&#39;spawnPatrice adds tube&#39;, state.items.patrice.length===pat0+1);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; // Bullet destroys obstacle</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const ob0=state.items.obstacles.length; state.items.obstacles.push({x:state.player.x,y:state.player.y-120,w:40,h:40,l:0,cone:false});</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const bulletsBefore=state.items.bullets.length;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; state.player.shootUntil = performance.now()+200; state.player.shootTimer=0;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const last = state.last; state.last = performance.now()-50; update(performance.now()); state.last=last;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; ok(&#39;bullet spawns when Patrice active&#39;, state.items.bullets.length&gt;bulletsBefore);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; ok(&#39;bullet can destroy obstacle&#39;, state.items.obstacles.length &lt; ob0+1);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; // Passenger watchdog: force long gap and large cooldown -&gt; should spawn</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; state.items.passengers.length = 0;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; state.spawn.pass = 999;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; state.lastPassengerSpawnAt = performance.now()-13000;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const beforeWatch = state.items.passengers.length;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; update(performance.now());</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; ok(&#39;passenger watchdog spawns&#39;, state.items.passengers.length &gt; beforeWatch);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }catch(e){</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; console.warn(&#39;Smoke tests error:&#39;, e);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }finally{</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; const pass = results.filter(r=&gt;r[1]).length;</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; console.log(&#39;%cSMOKE TESTS&#39;,&#39;font-weight:bold&#39;, results);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; &nbsp; if(pass!==results.length) console.warn(&#39;Some smoke tests failed&#39;, results);</span></p><p class="c1"><span class="c0">&nbsp; &nbsp; }</span></p><p class="c1"><span class="c0">&nbsp; })();</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">})();</span></p><p class="c1"><span class="c0">&lt;/script&gt;</span></p><p class="c1"><span class="c0">&lt;/body&gt;</span></p><p class="c1"><span class="c0">&lt;/html&gt;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1 c2"><span class="c0"></span></p></body></html>